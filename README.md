# Use Cloud Functions to automatically analyze images in Cloud Object Storage

[Cloud Functions](https://cloud.ibm.com/functions) can be extended by [integrating with Cloud Object Storage (COS)](https://cloud.ibm.com/docs/openwhisk?topic=cloud-functions-pkg_obstorage). The COS trigger type lets you run custom code logic when a new object is stored, updated, or deleted from a designated bucket in COS. 

This project shows a very common use for this type of trigger. Whenever an image file is uploaded to a [Cloud Object Storage](https://www.ibm.com/cloud/object-storage) bucket, a sequence of actions will generate a thumbnail for the image (a smaller version) and will use IBM Cloud Visual Recognition to identify objects, places, faces from the original image.

![create flow](./xdocs/create-flow.png)

1. The user uploads an image to the Cloud Object Storage bucket.
1. Cloud Object Storage sends an event to Cloud Functions.
1. This event triggers a sequence of actions:
   1. A thumbnail is generated and stored under the `thumbnails/` prefix in the bucket.
   1. Visual Recognition is called on the image and the results stored under the `metadata/` prefix in the bucket.

![delete flow](./xdocs/delete-flow.png)
1. The user deletes an image.
1. Cloud Object Storage sends an event to Cloud Functions.
1. The event triggers the delete action to remove the generated thumbnail and visual recognition metadata.

The two triggers shown in the diagrams above are:

| *Name* | *Trigger Type* | *Description* |
| --- | --- | --- |
| on-create | Cloud Object Storage | Called when files are added to the bucket |
| on-delete | Cloud Object Storage | Called when files are deleted from the bucket |

The triggers _trigger_ the following actions:

| *Name* | *Runtime* | *Description* |
| --- | --- | --- |
| on-create | Sequence | Called via the _on-create trigger_ when files are written to Cloud Object Storage. |
| filter | Node.js | Ignores non-image files and events generated by the thumbnails or visual recognition files. |
| thumbnail | Node.js | Uses [gm](https://aheckmann.github.io/gm/) to generate thumbnails from images stored in [Cloud Object Storage](https://github.com/IBM/ibm-cos-sdk-js). |
| visualrecognition | Node.js | Analyzes images with [Visual Recognition](https://github.com/watson-developer-cloud/node-sdk#visual-recognition) and stores the results in the bucket. |
| on-delete | Sequence | Called via the _on-delete trigger_ when files are deleted from Cloud Object Storage. |
| delete | Node.js | Removes thumbnails and visual recognition files. |

## Deploy the project

1. To run the following scripts, make sure to install:
   * [IBM Cloud CLI](https://cloud.ibm.com/docs/cli?topic=cloud-cli-install-ibmcloud-cli)
   * Cloud Object Storage plugin. Install it with `ibmcloud plugin install cloud-object-storage`.
   * Cloud Functions plugin. Install it with `ibmcloud plugin install cloud-functions`.
   * [jq](https://stedolan.github.io/jq/) command line utility

1. Copy the configuration file and set the values to match your environment. At a minimum, set or review the values for `PREFIX`, `RESOURCE_GROUP_NAME` and `REGION`.

   ```sh
   cp template.local.env local.env
   ```

1. Load the values into the current shell.

   ```sh
   source local.env
   ```

1. Ensure you have the prerequisites to run the scripts.

   ```sh
   ./000-prereqs.sh
   ```

1. Create Cloud Object Storage and Visual Recognition services.

   ```sh
   ./010-create-services.sh
   ```

   If they do not already exist, the script creates:
      * a Cloud Object Storage service instance and a service key,
      * a storage bucket
      * a Visual Recognition service instance and a service key.

   The previously defined `PREFIX` variable is used to define the names of these resources.

1. Create the actions and the triggers.

   ```sh
   ./020-create-functions.sh
   ```

1. From that point you can go into the Cloud Object Storage service instance and upload files from the IBM Cloud console. Or you can run this simple test which uses an image from [Unsplash](https://unsplash.com).

   ```sh
   ./030-test.sh
   ```

## Cleanup

To delete the services and Cloud Functions artifacts, run:

   ```sh
   ./040-cleanup.sh
   ```

   > The Cloud Object Storage bucket and service will only be deleted after you remove the uploaded files.
